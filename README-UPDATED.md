# Sistema de Microservicios con NestJS y Prisma

## üìã Descripci√≥n

Sistema completo de microservicios desarrollado con **NestJS**, **TypeScript** y **Prisma ORM**, que incluye:

- üåê **API Gateway** - Punto de entrada principal con autenticaci√≥n JWT
- üë§ **User Service** - Gesti√≥n de usuarios con PostgreSQL y Prisma
- üì¶ **Product Service** - Gesti√≥n de productos con MongoDB y Prisma  
- üîî **Notification Service** - Notificaciones en tiempo real con WebSockets y Redis
- üì® **NATS** - Sistema de mensajer√≠a para comunicaci√≥n entre microservicios

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   API Gateway   ‚îÇ    ‚îÇ   User Service  ‚îÇ    ‚îÇ Product Service ‚îÇ
‚îÇ    (Port 3000)  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   (Port 3001)   ‚îÇ    ‚îÇ   (Port 3002)   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ PostgreSQL+Prisma‚îÇ    ‚îÇ MongoDB+Prisma  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                        ‚îÇ                        ‚îÇ
         ‚îÇ                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ              
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇNotification Svc ‚îÇ‚îÇ              
                        ‚îÇ   (Port 3003)   ‚îÇ‚îÇ              
                        ‚îÇ WebSockets+Redis‚îÇ‚îÇ              
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ              
                               ‚îÇ           ‚îÇ
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
                        ‚îÇ      NATS       ‚îÇ‚îÇ
                        ‚îÇ   Message Bus   ‚îÇ‚îÇ
                        ‚îÇ   (Port 4222)   ‚îÇ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
```

## üöÄ Inicio R√°pido

### Prerrequisitos
- Docker y Docker Compose
- PowerShell (Windows) o Bash (Linux/Mac)
- Node.js 20+ (opcional, para desarrollo local)

### 1. Clonar el repositorio
```bash
git clone https://github.com/jaimeirazabal1/microservicios-base-nestjs
cd microservice-project
```

### 2. Iniciar todos los servicios (Recomendado)
```powershell
# Windows PowerShell
.\start-dev.ps1

# Linux/Mac Bash
./scripts/start-dev.sh
```

### 3. Inicio manual alternativo
```bash
# Construir e iniciar servicios
docker-compose up -d --build

# Ver logs en tiempo real
docker-compose logs -f
```

### 4. Verificar servicios
- üåê API Gateway: http://localhost:3000
- üë§ User Service: http://localhost:3001  
- üì¶ Product Service: http://localhost:3002
- üîî Notification Service: http://localhost:3003
- üì° NATS Monitoring: http://localhost:8222

## üîó Prisma Integration

### Caracter√≠sticas principales:
- ‚úÖ **Type-safe database queries** con Prisma Client
- ‚úÖ **Database migrations** autom√°ticas en Docker
- ‚úÖ **Multi-database support** (PostgreSQL + MongoDB)
- ‚úÖ **Development tooling** con Prisma Studio

### Prisma Studio (Database GUI)
```bash
# User Service (PostgreSQL)
docker-compose exec user-service npm run prisma:studio

# Product Service (MongoDB)  
docker-compose exec product-service npm run prisma:studio
```

### Database Schemas

#### User Service (PostgreSQL)
```prisma
model User {
  id         String    @id @default(uuid())
  email      String    @unique
  password   String
  name       String
  lastName   String?
  phone      String?
  avatar     String?
  roles      String[]  @default(["user"])
  isActive   Boolean   @default(true)
  lastLogin  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}
```

#### Product Service (MongoDB)
```prisma
model Product {
  id            String    @id @map("_id") @default(auto()) @db.ObjectId
  name          String
  description   String
  sku           String    @unique
  price         Float
  stock         Int
  categoryId    String    @db.ObjectId
  images        String[]
  tags          String[]
  isActive      Boolean   @default(true)
  reviews       Review[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Category {
  id          String   @id @map("_id") @default(auto()) @db.ObjectId
  name        String   @unique
  description String
  slug        String   @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

## üìä Servicios y Puertos

| Servicio | Puerto | Base de Datos | ORM | Descripci√≥n |
|----------|--------|---------------|-----|-------------|
| API Gateway | 3000 | - | - | Enrutamiento y autenticaci√≥n |
| User Service | 3001 | PostgreSQL:5432 | Prisma | Gesti√≥n de usuarios |
| Product Service | 3002 | MongoDB:27017 | Prisma | Gesti√≥n de productos |
| Notification Service | 3003 | Redis:6379 | - | Notificaciones tiempo real |
| NATS | 4222 | - | - | Message broker |

## üîß Desarrollo Local

### Variables de entorno
Cada servicio tiene su archivo `.env` configurado autom√°ticamente:

```bash
# User Service
DATABASE_URL=postgresql://postgres:postgres123@postgres:5432/userdb

# Product Service  
DATABASE_URL=mongodb://mongo:mongo123@mongodb:27017/productdb?authSource=admin

# Notification Service
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=redis123
```

### Comandos √∫tiles de Prisma
```bash
# Generar cliente Prisma
docker-compose exec user-service npm run prisma:generate
docker-compose exec product-service npm run prisma:generate

# Aplicar cambios de schema a la BD
docker-compose exec user-service npm run prisma:push
docker-compose exec product-service npm run prisma:push

# Crear nueva migraci√≥n
docker-compose exec user-service npm run prisma:migrate
```

### Ver logs de servicios
```bash
# Todos los servicios
docker-compose logs -f

# Servicio espec√≠fico
docker-compose logs -f user-service
docker-compose logs -f product-service
docker-compose logs -f notification-service
```

## üì° API Endpoints

### Autenticaci√≥n (via API Gateway)
```http
POST /api/v1/auth/register    # Registro de usuario
POST /api/v1/auth/login       # Login con JWT
GET  /api/v1/auth/profile     # Perfil de usuario (JWT requerido)
```

### Usuarios
```http
GET    /api/v1/users          # Listar usuarios (paginado)
GET    /api/v1/users/:id      # Obtener usuario por ID
POST   /api/v1/users          # Crear nuevo usuario
PUT    /api/v1/users/:id      # Actualizar usuario
DELETE /api/v1/users/:id      # Eliminar usuario
```

### Productos
```http
GET    /api/v1/products              # Listar productos (con filtros)
GET    /api/v1/products/:id          # Obtener producto por ID
POST   /api/v1/products              # Crear nuevo producto
PUT    /api/v1/products/:id          # Actualizar producto
DELETE /api/v1/products/:id          # Eliminar producto
POST   /api/v1/products/:id/reviews  # Agregar rese√±a
GET    /api/v1/products/featured     # Productos destacados
```

### Categor√≠as
```http
GET    /api/v1/categories       # Listar categor√≠as
GET    /api/v1/categories/:id   # Obtener categor√≠a por ID
POST   /api/v1/categories       # Crear nueva categor√≠a
PUT    /api/v1/categories/:id   # Actualizar categor√≠a
DELETE /api/v1/categories/:id   # Eliminar categor√≠a
```

### Notificaciones
```http
GET  /api/v1/notifications           # Obtener notificaciones del usuario
POST /api/v1/notifications/send      # Enviar notificaci√≥n
POST /api/v1/notifications/:id/read  # Marcar como le√≠da
GET  /api/v1/notifications/unread-count # Contador de no le√≠das
POST /api/v1/notifications/broadcast # Enviar a todos los usuarios
```

## üîå WebSockets (Notificaciones en Tiempo Real)

### Conexi√≥n
```javascript
import io from 'socket.io-client';

const socket = io('http://localhost:3003/notifications', {
  query: { userId: 'user-id-here' }
});
```

### Eventos disponibles
```javascript
// Escuchar nueva notificaci√≥n
socket.on('new_notification', (notification) => {
  console.log('Nueva notificaci√≥n:', notification);
});

// Escuchar actualizaciones de contador
socket.on('unread_count_update', (data) => {
  console.log('Notificaciones no le√≠das:', data.count);
});

// Eventos de conexi√≥n
socket.on('connect', () => {
  console.log('Conectado al servidor de notificaciones');
});

socket.on('disconnect', () => {
  console.log('Desconectado del servidor');
});
```

## üóÑÔ∏è Bases de Datos

### PostgreSQL (User Service con Prisma)
```bash
# Conectar a la base de datos
docker exec -it microservices-postgres psql -U postgres -d userdb

# Ver tablas
\dt

# Consultar usuarios
SELECT * FROM "User";
```

### MongoDB (Product Service con Prisma)
```bash
# Conectar a MongoDB
docker exec -it microservices-mongo mongosh -u mongo -p mongo123 --authenticationDatabase admin

# Usar base de datos
use productdb

# Ver colecciones
show collections

# Consultar productos
db.Product.find().pretty()
```

### Redis (Notification Service)
```bash
# Conectar a Redis
docker exec -it microservices-redis redis-cli -a redis123

# Ver todas las claves
KEYS *

# Ver notificaciones de un usuario
LRANGE notifications:user123 0 -1
```

## üõ†Ô∏è Scripts y Comandos √ötiles

### PowerShell (Windows)
```powershell
# Iniciar desarrollo completo
.\start-dev.ps1

# Detener todos los servicios
.\stop-dev.ps1
```

### Bash (Linux/Mac)
```bash
# Iniciar desarrollo
./scripts/start-dev.sh

# Detener servicios
./scripts/stop-dev.sh

# Construir todos los servicios
./scripts/build-all.sh
```

### Docker Compose manual
```bash
# Construir e iniciar
docker-compose up -d --build

# Solo bases de datos
docker-compose up -d postgres mongodb redis nats

# Solo microservicios
docker-compose up -d user-service product-service notification-service api-gateway

# Reconstruir servicio espec√≠fico
docker-compose up -d --build user-service

# Ver estado de servicios
docker-compose ps

# Limpiar todo (‚ö†Ô∏è elimina datos)
docker-compose down -v
```

## üß™ Testing y Verificaci√≥n

### Health checks autom√°ticos
Todos los servicios incluyen health checks:
```bash
# Ver estado de salud de servicios
docker-compose ps
```

### Pruebas manuales
```bash
# Test de conectividad
curl http://localhost:3000/health
curl http://localhost:3001/health
curl http://localhost:3002/health
curl http://localhost:3003/health

# Test de autenticaci√≥n
curl -X POST http://localhost:3000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123","name":"Test User"}'
```

## üì¶ Estructura del Proyecto

```
microservice-project/
‚îú‚îÄ‚îÄ microservices/
‚îÇ   ‚îú‚îÄ‚îÄ api-gateway/          # Gateway principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îÇ   ‚îú‚îÄ‚îÄ user-service/         # Gesti√≥n de usuarios + Prisma
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îÇ   ‚îú‚îÄ‚îÄ product-service/      # Gesti√≥n de productos + Prisma
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îÇ   ‚îî‚îÄ‚îÄ notification-service/ # Notificaciones + Redis
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ       ‚îî‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ shared/                   # C√≥digo compartido
‚îú‚îÄ‚îÄ scripts/                  # Scripts de automatizaci√≥n
‚îú‚îÄ‚îÄ docker-compose.yml        # Orquestaci√≥n unificada
‚îú‚îÄ‚îÄ start-dev.ps1            # Script de inicio (PowerShell)
‚îú‚îÄ‚îÄ stop-dev.ps1             # Script de parada (PowerShell)
‚îî‚îÄ‚îÄ .env.example             # Variables de entorno de ejemplo
```

## üîê Autenticaci√≥n y Autorizaci√≥n

### JWT Configuration
```typescript
// Configuraci√≥n en cada servicio
{
  secret: 'your-super-secret-jwt-key-change-in-production',
  expiresIn: '24h'
}
```

### Uso de tokens
```javascript
// Obtener token
const response = await fetch('/api/v1/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ 
    email: 'user@example.com', 
    password: 'password123' 
  })
});

const { access_token } = await response.json();

// Usar token en peticiones protegidas
const userResponse = await fetch('/api/v1/users/profile', {
  headers: { 'Authorization': `Bearer ${access_token}` }
});
```

## üö® Soluci√≥n de Problemas

### Problemas con Prisma
```bash
# Regenerar cliente Prisma
docker-compose exec user-service npm run prisma:generate
docker-compose exec product-service npm run prisma:generate

# Reset completo de base de datos (‚ö†Ô∏è elimina datos)
docker-compose exec user-service npx prisma migrate reset --force
```

### Problemas de conectividad
```bash
# Verificar que las redes Docker est√©n correctas
docker network ls
docker network inspect microservices-network

# Reiniciar servicios con dependencias
docker-compose restart
```

### Problemas de puertos
```bash
# Ver qu√© procesos usan los puertos
netstat -an | findstr "3000 3001 3002 3003"

# Modificar puertos en docker-compose.yml si es necesario
```

### Logs de debug
```bash
# Logs detallados de un servicio
docker-compose logs -f --tail=100 user-service

# Logs de todas las bases de datos
docker-compose logs postgres mongodb redis nats
```

## üìà Pr√≥ximos Pasos y Mejoras

- [ ] **Tests automatizados** (Unit + Integration)
- [ ] **Documentaci√≥n Swagger/OpenAPI** autom√°tica
- [ ] **Circuit breakers** con resilience patterns
- [ ] **Monitoreo avanzado** (Prometheus + Grafana)
- [ ] **Logging centralizado** (ELK Stack)
- [ ] **CI/CD pipeline** completo
- [ ] **Rate limiting** por usuario/IP
- [ ] **Distributed tracing** con Jaeger
- [ ] **API versioning** strategy
- [ ] **Database seeders** con datos de prueba

## üîó Recursos Adicionales

- [Prisma Documentation](https://www.prisma.io/docs/)
- [NestJS Documentation](https://docs.nestjs.com/)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [NATS Documentation](https://docs.nats.io/)

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crear rama feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit cambios (`git commit -am 'Agregar nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Crear Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la licencia UNLICENSED.

---

## ‚úÖ Principales Cambios Realizados

### üîÑ Migraci√≥n a Prisma ORM
- ‚úÖ **User Service**: Configurado con Prisma + PostgreSQL
- ‚úÖ **Product Service**: Configurado con Prisma + MongoDB  
- ‚úÖ **Schemas actualizados** con modelos type-safe
- ‚úÖ **Migraciones autom√°ticas** en Docker containers

### üê≥ Docker Unificado
- ‚úÖ **Un solo docker-compose.yml** centralizado
- ‚úÖ **Health checks** para todas las bases de datos
- ‚úÖ **Dependencias correctas** entre servicios
- ‚úÖ **Variables de entorno** estandarizadas
- ‚úÖ **Vol√∫menes persistentes** para datos

### üõ†Ô∏è Automatizaci√≥n
- ‚úÖ **Scripts PowerShell** para Windows
- ‚úÖ **Scripts Bash** para Linux/Mac  
- ‚úÖ **Inicializaci√≥n autom√°tica** de Prisma
- ‚úÖ **Configuraci√≥n de red** Docker optimizada

**¬°Listo para usar! üéâ**

Para cualquier duda, ejecuta:
```powershell
.\start-dev.ps1  # y sigue las instrucciones en pantalla
```